<!-- BASE WIZARD CARRITO DE COMPRAS -->
<section class="container">
  <mat-horizontal-stepper linear #stepper="matHorizontalStepper">

    <!-- PASO 1 MI CARRITO -->
    <mat-step [completed]="this.pedido.videojuegos.length != 0" label="MI COMPRA">
      <div class="container">
        <div class="row pt-5">
          <div class="col-9">

            <h5>CARRITO</h5>
            <mat-divider class="mb-3"></mat-divider>
            
            <div *ngIf="this.pedido.videojuegos.length == 0" 
            class="alert alert-secondary">
                Aun no agregaste ningun articulo al carrito.
            </div>
            <table *ngIf="this.pedido.videojuegos.length != 0" class="table">
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">IMAGEN</th>
                  <th scope="col">TITULO</th>
                  <th scope="col">PRECIO</th>
                  <th scope="col">CANTIDAD</th>
                  <th scope="col">SUBTOTAL</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of pedido.videojuegos, index as i">
                  <td><button (click)="removeItem(i)" class="btn btn-danger btn-xsm"> 
                    <i class="material-icons">
                      delete
                      </i></button></td>
                  <td><img width="180px" height="90px" class="align-center"[src]="item.videojuego.imagen"></td>
                  <td>{{item.videojuego.titulo}}</td>
                  <td>$ {{item.videojuego.precio}}</td>
                  <td><input min="1" max="10" class="w-50" type="number" (change)="updateTotal()" 
                    [(ngModel)]="item.cantidad"></td>
                  <td>$ {{item.subtotal}}</td>
                </tr>
              </tbody>
            </table>

          </div>

          <div class="col-3">
            <div class="row border border-dark justify-content-center p-3">
              <div class="col-12 d-flex justify-content-between align-items-center alert alert-dark p-2 m-0">
                <label>Subtotal:</label>
                <span>$ {{pedido.subtotal}}</span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Costo de envio:</label>
                <span> - </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Descuentos:</label>
                <span> - </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Total:</label>
                <span> - </span>
              </div>
            </div>
            <div class="row justify-content-center mt-5">
              <button [disabled]="this.pedido.videojuegos.length == 0" matStepperNext type="button" class="btn btn-block btn-elegant waves-light font-weight-bold">
                CONTINUAR
              </button>
            </div>
          </div>
        </div>
      </div>
    </mat-step>

    <!-- PASO 2 ENTREGA -->
    <mat-step [completed]="tipoDeEntregaCompletado()" label="ENTREGA">

      <div class="container">

        <div class="row pt-5">

          <div class="col-12 col-lg-9 d-flex flex-column">

            <div class="container">
              <h5>FORMA DE ENTREGA</h5>

              <mat-divider class="mb-3"></mat-divider>

              <mat-radio-group class="d-flex flex-row justify-content-start mb-5" (change)="actualizarTipoEntrega()" [(ngModel)]="formaEntrega">
                <mat-radio-button class="mr-5" labelPosition="before" [value]="1">
                  <span>Retiro en sucursal</span>
                </mat-radio-button>
                <mat-radio-button labelPosition="before" [value]="2">
                  <span>Envio a domicilio</span>
                </mat-radio-button>
              </mat-radio-group>

              <div *ngIf="formaEntrega == 1">
                <mat-form-field class="w-75">
                  <mat-select (change)="actualizarTipoEntrega($event.value)" placeholder="Selecciona una sucursal">
                    <mat-option *ngFor="let s of sucursales" [value]="s">
                      {{ s.ubicacion.calle }} {{ s.ubicacion.altura }}, {{ s.ubicacion.barrio.nombre }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                  <div *ngIf="ofertaSucursalInvalida" class="alert alert-danger" role="alert">
                    Uno o mas ofertas de su pedido no se encuentran disponibles
                    en la sucursal seleccionada, intente con otra.
                  </div>

              </div>

              <div *ngIf="formaEntrega == 2">
                
                <div class="d-flex flex-row justify-content-between">
  
                  <mat-form-field class="w-75">
                    <mat-select (change)="actualizarTipoEntrega($event.value)" placeholder="Seleccione un domicilio">
                      <mat-option *ngFor="let d of cliente.domicilio_entrega" [value]="d">
                        {{ d.calle}} {{d.altura}}, {{d.barrio.nombre}} 
                      </mat-option>
                      <mat-option [value]="'otro'">
                        Otro domicilio
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <button [disabled]="!tipoEntregaValida || costoEnvioCalculado" 
                  (click)="calcularCostoEnvio()" class="btn btn-elegant font-weight-bold">
                    CALCULAR <br> COSTO ENVIO
                  </button>

                </div>

                <mat-accordion *ngIf="esVisibleFormDomicilio">
                  <mat-expansion-panel class="w-75">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        Datos de envio
                      </mat-panel-title>
                      <mat-panel-description>
                        complete datos del domicilio de entrega
                      </mat-panel-description>
                    </mat-expansion-panel-header>

                    <form class="d-flex flex-column" [formGroup]="formDomicilio"> 

                        <mat-form-field floatLabel="never">
                            <mat-select placeholder="Barrio" formControlName="barrio">
                                <mat-option *ngFor="let barrio of barrios" [value]="barrio">
                                  {{barrio.nombre}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input matInput placeholder="Calle" formControlName="calle" required>
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input matInput placeholder="Altura" formControlName="altura">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                            <input matInput placeholder="Codigo postal" formControlName="codigo_postal">
                            <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                  </form>

                  </mat-expansion-panel>
                </mat-accordion>
              </div>
            </div>

          </div>
          <div class="col-12 col-lg-3">
            <div class="row border border-dark justify-content-center p-3">
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Subtotal:</label>
                <span>$ {{pedido.subtotal}}</span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center alert alert-dark p-2 m-0">
                <label>Costo de envio:</label>
                <span> $ {{pedido.costoEnvio}} </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Descuentos:</label>
                <span> - </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Total:</label>
                <span> - </span>
              </div>
            </div>
            <div class="row justify-content-center mt-5">
              <button [disabled]="!tipoDeEntregaCompletado()" matStepperNext class="btn btn-block btn-elegant waves-light font-weight-bold">
                CONTINUAR
              </button>
            </div>
          </div>
        </div>
      </div>
    </mat-step>

    <!-- PASO 3 PAGO -->
    <mat-step label="PAGO">

      <div class="container">

        <div class="row pt-5">

          <div class="col-12 col-lg-9 d-flex flex-column">

            <div class="container">
              <h5>MEDIO DE PAGO</h5>

              <mat-divider class="mb-3"></mat-divider>

              <mat-radio-group class="d-flex flex-row justify-content-start mb-5" [(ngModel)]="formaDePago">
                <mat-radio-button class="mr-5" labelPosition="before" [value]="1">
                  <span>Efectivo en sucursal</span>
                </mat-radio-button>
                <mat-radio-button labelPosition="before" [value]="2">
                  <span>Tarjeta</span>
                </mat-radio-button>
              </mat-radio-group>

              <div *ngIf="formaDePago == 1">
                <div class="alert alert-warning" role="alert">
                  Su pedido sera reservado por 7 días hábiles a partir de la fecha de compra, en caso de no retirarlo en dicho periodo usted
                  podrá ser
                  <b>penalizado</b>.
                </div>
              </div>

              <div *ngIf="formaDePago == 2">

                <mat-form-field floatLabel="never" class="w-75">
                  <mat-select placeholder="Seleccione una tarjeta">
                    <mat-option *ngFor="let t of cliente.tarjetas" [value]="t">
                      <span>{{t.tipoTarjeta}} terminada en
                        <b>...{{t.numero | slice:-4 }}</b>
                      </span>
                    </mat-option>
                    <mat-option [value]="'nuevaTarjeta'">
                      Otra tarjeta
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-accordion *ngIf="esVisibleFormTarjeta">
                  <mat-expansion-panel class="w-75">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        Complete datos de facturación
                      </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="d-flex flex-column">

                      <h6 class="mt-4">Datos de tarjeta</h6>
                      <mat-divider class="mb-3"></mat-divider>
                      <form  [formGroup]="formTarjeta">
                        <mat-form-field>
                          <mat-select formControlName="tipoTarjeta" placeholder="Tipo de tarjeta">
                            <mat-option [value]="'Mastercard'">
                              Mastercard
                            </mat-option>
                            <mat-option [value]="'Visa'">
                              Visa
                            </mat-option>
                            <mat-option [value]="'American Express'">
                              American Express
                            </mat-option>
                            <mat-option [value]="'Cabal'">
                              Cabal
                            </mat-option>
                          </mat-select>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input matInput formControlName="nombre" placeholder="Nombre en tarjeta">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input matInput formControlName="numero" placeholder="Numero">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input matInput formControlName="vencimiento" [matDatepicker]="myDatepicker" placeholder="Fecha de vencimiento" disabled>
                          <mat-datepicker-toggle matSuffix [for]="myDatepicker"></mat-datepicker-toggle>
                          <mat-datepicker #myDatepicker disabled="false" touchUi="true"></mat-datepicker>
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input formControlName="codigo" matInput placeholder="Codigo de seguridad">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <h6 class="mt-4">Dirección de facturación</h6>
                        <mat-divider class="mb-3"></mat-divider>
                        <mat-form-field floatLabel="never">
                          <input formControlName="calle" matInput placeholder="Calle">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input matInput formControlName="altura" placeholder="Altura">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>

                        <mat-form-field floatLabel="never">
                          <input formControlName="barrio" matInput placeholder="Ciudad">
                          <mat-error> campo invalido</mat-error>
                        </mat-form-field>
                    </form>

                    </div>

                  </mat-expansion-panel>
                </mat-accordion>
              </div>
            </div>

          </div>
          <div class="col-12 col-lg-3">
            <div class="row border border-dark justify-content-center p-3">
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Subtotal:</label>
                <span>$ {{pedido.subtotal}}</span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2 m-0">
                <label>Costo de envio:</label>
                <span>$ {{pedido.costoEnvio}} </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Descuentos:</label>
                <span> - </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Total:</label>
                <span> - </span>
              </div>
            </div>
            <div class="row justify-content-center mt-5">
              <button matStepperNext class="btn btn-block btn-elegant waves-light font-weight-bold">
                CONTINUAR
              </button>
            </div>
          </div>
        </div>
      </div>
    </mat-step>


    <!-- PASO 4 CONFIRMAR COMPRA -->
    <mat-step label="CONFIRMAR COMPRA">
      <div class="container">
        
        <div class="row pt-5">

          <div class="col-12 col-lg-9 d-flex flex-column">
            <section class="mb-3 mt-3">
              <h6>CARRITO</h6>
              <mat-divider class="mb-4"></mat-divider>
              <ng2-smart-table [settings]="settings" [source]="data"></ng2-smart-table>
            </section>
            <section class="mb-3 mt-3">
              <h6>FORMA DE ENTREGA</h6>
              <mat-divider class="mb-4"></mat-divider>
              <div class="d-flex d-row justify-content-between h-50">
                <span class="alert alert-dark w-50 d-flex justify-content-center align-items-center">Entrega a domicilio</span>
                <span class="alert alert-dark">Defensa 7010, San Telmo</span>
              </div>
            </section>
            <section class="mb-3 mt-3">
              <h6>MEDIO DE PAGO</h6>
              <mat-divider class="mb-4"></mat-divider>
              <div class="d-flex d-row justify-content-between h-50">
                <span class="alert alert-dark w-50 d-flex justify-content-center align-items-center">Tarjeta</span>
                <span class="alert alert-dark">Visa terminada en ...5631</span>
              </div>
            </section>
            <section class="mb-3 mt-3">
              <h6>DESCUENTOS</h6>
              <mat-divider class="mb-4"></mat-divider>
              <div class="d-flex d-row justify-content-between">
                <mat-form-field class="w-50">
                    <input matInput placeholder="Cupon de descuento">
                </mat-form-field>
                <button mat-button mat-raised-button>APLICAR DESCUENTO</button>
              </div>
            </section>
          </div>

          <div class="col-12 col-lg-3 sticky-top">
            <div class="row border border-dark justify-content-center p-3">
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Subtotal:</label>
                <span>$ 2000.00</span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2 m-0">
                <label>Costo de envio:</label>
                <span> $ 200 </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center p-2">
                <label>Descuentos:</label>
                <span> $50 </span>
              </div>
              <div class="col-12 d-flex justify-content-between align-items-center alert alert-dark p-2 m-0">
                <label>Total:</label>
                <span> $1500 </span>
              </div>
            </div>
            <div class="row justify-content-center mt-5">
              <button (click)="confirmPurchase()" matStepperNext class="btn btn-block btn-elegant waves-light font-weight-bold sticky-top">
                CONFIRMAR COMPRA
              </button>
            </div>
          </div>
        </div>
      </div>

    </mat-step>
  </mat-horizontal-stepper>
</section>